<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>운정고 1-3반 단합게임</title>
  <link rel="stylesheet" href="styles.css"/>
</head>
<body>
  <!-- 팀명 입력 모달 -->
  <div id="teamModal" class="modal">
    <div class="modal__card">
      <h2 class="modal__title">1–5팀 팀명을 정해주세요</h2>
      <p class="modal__subtitle">하나씩 입력하고 “다음” 버튼을 눌러요.</p>
      <div class="modal__step">
        <label id="teamModalLabel" for="teamNameInput">팀 1 이름</label>
        <input id="teamNameInput" type="text" placeholder="예: 썬더팀" />
      </div>
      <div class="modal__actions">
        <button id="teamModalNext" class="btn primary">다음</button>
      </div>
    </div>
  </div>

  <div class="page">
    <header class="header">
      <h1>운정고 1-3반 단합게임</h1>
      <p class="header__sub">점수 관리 · 타이머 · 사다리타기</p>
    </header>

    <!-- 메인 화면 (점수 / 타이머 / 순위) -->
    <main id="mainView" class="view">
      <!-- 점수 카드 -->
      <section class="card card--scores">
        <h2>팀 점수 관리</h2>

        <div class="controls">
          <div class="control">
            <label>팀 선택</label>
            <div id="teamChipWrap" class="chip-row"></div>
          </div>

          <div class="control">
            <label for="scoreDelta">추가 / 차감할 점수</label>
            <input id="scoreDelta" type="number" value="1" />
            <div class="preset-row">
              <button class="chip chip--small" data-delta="1">+1</button>
              <button class="chip chip--small" data-delta="5">+5</button>
              <button class="chip chip--small" data-delta="10">+10</button>
              <button class="chip chip--small" data-delta="-1">-1</button>
              <button class="chip chip--small" data-delta="-5">-5</button>
              <button class="chip chip--small" data-delta="-10">-10</button>
            </div>
          </div>

          <div class="control control--actions">
            <button id="btnAddScore" class="btn primary">선택 팀 점수 적용</button>
            <button id="btnResetScore" class="btn subtle">점수 전부 0점</button>
            <button id="btnRenameTeams" class="btn outline">팀명 다시 설정</button>
          </div>
        </div>

        <div class="table-wrap">
          <table class="score-table">
            <thead>
              <tr>
                <th>팀</th>
                <th>점수</th>
              </tr>
            </thead>
            <tbody id="scoreTableBody"></tbody>
          </table>
        </div>

        <div class="result-row">
          <button id="btnShowRank" class="btn">결과 보기 (순위)</button>
          <span id="rankHint" class="hint is-hidden">아래 “최종 순위”에서 확인하세요.</span>
        </div>
      </section>

      <!-- 타이머 / 스탑워치 카드 -->
      <section class="card card--timer">
        <h2>타이머 · 스탑워치</h2>

        <div class="timer">
          <div class="timer__mode-row">
            <button id="modeStopwatch" class="chip chip--mode chip--active">스탑워치</button>
            <button id="modeCountdown" class="chip chip--mode">타이머</button>
          </div>

          <!-- 0.01초 단위, 초 부분 크게 -->
          <div id="timerDisplay" class="timer__display">
            <span class="timer-min"   id="tmMin">00</span>
            <span class="timer-colon">:</span>
            <span class="timer-sec"   id="tmSec">00</span>
            <span class="timer-dot">.</span>
            <span class="timer-centi" id="tmCenti">00</span>
          </div>

          <div id="timerInputRow" class="timer__input-row">
            <label>
              분
              <input id="timerMin" type="number" min="0" value="1">
            </label>
            <label>
              초
              <input id="timerSec" type="number" min="0" max="59" value="0">
            </label>
          </div>

          <div class="timer__btn-row">
            <button id="btnTimerStart" class="btn primary">시작</button>
            <button id="btnTimerPause" class="btn subtle">일시정지</button>
            <button id="btnTimerReset" class="btn outline">초기화</button>
          </div>
        </div>

        <div class="goto-ladder">
          <p class="hint">점수 정리가 끝났다면, 아래 버튼으로 사다리타기로 넘어가세요.</p>
          <button id="btnGotoLadder" class="btn primary btn--full">사다리타기 하러 가기 →</button>
        </div>
      </section>

      <!-- 순위 카드 -->
      <section class="card card--rank">
        <h2>최종 순위 (점수 기준)</h2>
        <div id="rankEmpty" class="hint">“결과 보기 (순위)” 버튼을 누르면 순위가 나타납니다.</div>
        <ol id="rankList" class="rank-list is-hidden"></ol>
      </section>
    </main>

    <!-- 사다리 화면 -->
    <main id="ladderView" class="view is-hidden">
      <section class="card card--ladder">
        <div class="ladder__header">
          <div>
            <h2>사다리타기</h2>
            <p class="hint">SVG 사다리를 따라 팀별로 한 칸씩 내려가요.</p>
          </div>
          <div class="ladder__header-actions">
            <button id="btnBackMain" class="btn outline">← 점수 화면</button>
            <button id="btnRegenLadder" class="btn subtle">사다리 새로 만들기</button>
          </div>
        </div>

        <div class="svg-wrap" title="클릭하면 현재 팀이 이동합니다">
          <svg id="ladderSvg" width="760" height="560" role="img" aria-label="사다리"></svg>
        </div>

        <div class="ladder__controls">
          <button id="btnLadderStep" class="btn primary">다음 팀 진행 (클릭 / 스페이스)</button>
          <span id="ladderHint" class="hint">현재 대기: 팀 1</span>
        </div>

        <div class="ladder__bottom-grid">
          <div class="mini-card">
            <h3>도착 순서 (왼쪽 → 오른쪽)</h3>
            <ol id="ladderOrder" class="ordered-list"></ol>
          </div>
          <div class="mini-card">
            <h3>출발 열 → 도착 열 매핑</h3>
            <div id="mappingGrid" class="mapping-grid"></div>
          </div>
        </div>
      </section>
    </main>
  </div>

  <!-- ====================
       JavaScript
  ===================== -->
  <script>
    // ===== LocalStorage 키 =====
    const LS_KEY_TEAMS = 'u13_teams';
    const LS_KEY_NAMES_SET = 'u13_teamNamesSet';
    const TEAM_COUNT = 5;

    // ===== 팀 데이터 =====
    const teams = Array.from({ length: TEAM_COUNT }, (_, i) => ({
      id: i + 1,
      name: '팀 ' + (i + 1),
      score: 0,
    }));

    // 저장된 팀 정보 불러오기
    (function loadTeams() {
      const saved = localStorage.getItem(LS_KEY_TEAMS);
      if (!saved) return;
      try {
        const arr = JSON.parse(saved);
        if (Array.isArray(arr) && arr.length === TEAM_COUNT) {
          arr.forEach((t, idx) => {
            if (!t) return;
            if (typeof t.name === 'string') teams[idx].name = t.name;
            if (typeof t.score === 'number') teams[idx].score = t.score;
          });
        }
      } catch (e) {}
    })();

    function saveTeams() {
      localStorage.setItem(LS_KEY_TEAMS, JSON.stringify(teams));
    }

    // ===== 공통 DOM =====
    const mainView = document.getElementById('mainView');
    const ladderView = document.getElementById('ladderView');

    // 모달
    const teamModal = document.getElementById('teamModal');
    const teamModalLabel = document.getElementById('teamModalLabel');
    const teamNameInput = document.getElementById('teamNameInput');
    const teamModalNext = document.getElementById('teamModalNext');
    let modalStep = 0; // 0~4

    // 점수 / 순위 DOM
    const teamChipWrap = document.getElementById('teamChipWrap');
    const scoreDeltaInput = document.getElementById('scoreDelta');
    const btnAddScore = document.getElementById('btnAddScore');
    const btnResetScore = document.getElementById('btnResetScore');
    const btnRenameTeams = document.getElementById('btnRenameTeams');
    const scoreTableBody = document.getElementById('scoreTableBody');
    const btnShowRank = document.getElementById('btnShowRank');
    const rankHint = document.getElementById('rankHint');
    const rankEmpty = document.getElementById('rankEmpty');
    const rankList = document.getElementById('rankList');

    // 타이머 DOM
    const modeStopwatchBtn = document.getElementById('modeStopwatch');
    const modeCountdownBtn = document.getElementById('modeCountdown');
    const timerDisplay = document.getElementById('timerDisplay');
    const timerInputRow = document.getElementById('timerInputRow');
    const timerMinInput = document.getElementById('timerMin');
    const timerSecInput = document.getElementById('timerSec');
    const btnTimerStart = document.getElementById('btnTimerStart');
    const btnTimerPause = document.getElementById('btnTimerPause');
    const btnTimerReset = document.getElementById('btnTimerReset');
    const btnGotoLadder = document.getElementById('btnGotoLadder');

    // 타이머 숫자 DOM
    const tmMinEl   = document.getElementById('tmMin');
    const tmSecEl   = document.getElementById('tmSec');
    const tmCentiEl = document.getElementById('tmCenti');

    // 사다리 DOM
    const ladderSvg = document.getElementById('ladderSvg');
    const btnBackMain = document.getElementById('btnBackMain');
    const btnRegenLadder = document.getElementById('btnRegenLadder');
    const btnLadderStep = document.getElementById('btnLadderStep');
    const ladderHint = document.getElementById('ladderHint');
    const ladderOrder = document.getElementById('ladderOrder');
    const mappingGrid = document.getElementById('mappingGrid');

    // ===== 점수 상태 =====
    let selectedTeamId = 1;

    // ===== 타이머 상태 (0.01초 단위) =====
    let timerMode = 'stopwatch'; // 'stopwatch' | 'countdown'
    let timerInterval = null;
    let elapsedMs = 0;           // 스탑워치
    let remainingMs = 0;         // 카운트다운
    let stopwatchStart = null;
    let countdownStart = null;
    let initialCountdownMs = 0;

    // ===== 사다리 상태 =====
    const LADDER_COLS = 5;
    const LADDER_WIDTH = 760;
    const LADDER_HEIGHT = 560;
    const PAD_X = 70;
    const TOP_Y = 30;
    const BOTTOM_Y = LADDER_HEIGHT - 30;
    const COL_GAP = (LADDER_WIDTH - PAD_X * 2) / (LADDER_COLS - 1);
    const X_POSITIONS = Array.from({ length: LADDER_COLS }, (_, i) => PAD_X + i * COL_GAP);

    let rungs = [];
    let paths = [];
    let currentStarter = 0;
    let currentAnimIndex = -1;
    let progress = 0;
    let rafId = null;

    // =========================
    // 팀명 입력 모달
    // =========================
    function openTeamModal() {
      modalStep = 0;
      teamModalLabel.textContent = '팀 1 이름';
      teamNameInput.value = '';
      teamModal.classList.add('is-open');
      setTimeout(() => teamNameInput.focus(), 0);
    }

    function closeTeamModal() {
      teamModal.classList.remove('is-open');
    }

    function submitTeamName() {
      const name = teamNameInput.value.trim();
      if (!name) return;
      teams[modalStep].name = name;
      saveTeams();

      modalStep += 1;
      if (modalStep < TEAM_COUNT) {
        teamNameInput.value = '';
        teamModalLabel.textContent = `팀 ${modalStep + 1} 이름`;
        teamNameInput.focus();
        renderTeamChips();
        renderScoreTable();
        drawLadder();
      } else {
        localStorage.setItem(LS_KEY_NAMES_SET, '1');
        closeTeamModal();
        renderTeamChips();
        renderScoreTable();
        buildLadder();
      }
    }

    teamModalNext.addEventListener('click', submitTeamName);
    teamNameInput.addEventListener('keydown', (e) => {
      if (e.key === 'Enter') submitTeamName();
    });

    if (localStorage.getItem(LS_KEY_NAMES_SET) === '1') {
      teamModal.classList.remove('is-open');
    } else {
      openTeamModal();
    }

    // =========================
    // 점수 렌더링 / 로직
    // =========================
    function renderTeamChips() {
      teamChipWrap.innerHTML = '';
      teams.forEach(t => {
        const btn = document.createElement('button');
        btn.className = 'chip chip--team' + (t.id === selectedTeamId ? ' chip--active' : '');
        btn.textContent = t.name;
        btn.addEventListener('click', () => {
          selectedTeamId = t.id;
          renderTeamChips();
        });
        teamChipWrap.appendChild(btn);
      });
    }

    function renderScoreTable() {
      scoreTableBody.innerHTML = '';
      teams.forEach(t => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${t.name}</td>
          <td class="score-cell">${t.score}</td>
        `;
        scoreTableBody.appendChild(tr);
      });
    }

    function applyScore() {
      const team = teams.find(t => t.id === selectedTeamId);
      if (!team) return;
      const delta = Number(scoreDeltaInput.value);
      const validDelta = Number.isFinite(delta) ? delta : 0;
      team.score += validDelta;      // 마이너스 허용
      saveTeams();
      renderScoreTable();
    }

    function resetScores() {
      teams.forEach(t => t.score = 0);
      saveTeams();
      renderScoreTable();
      hideRanking();
    }

    function showRanking() {
      const sorted = [...teams].sort((a, b) => b.score - a.score || a.id - b.id);
      rankList.innerHTML = '';
      sorted.forEach((t, idx) => {
        const li = document.createElement('li');
        li.innerHTML = `
          <span class="rank-badge">${idx + 1}</span>
          <span class="rank-team">${t.name}</span>
          <span class="rank-score">${t.score}점</span>
        `;
        rankList.appendChild(li);
      });
      rankEmpty.classList.add('is-hidden');
      rankList.classList.remove('is-hidden');
      rankHint.classList.remove('is-hidden');
    }

    function hideRanking() {
      rankList.classList.add('is-hidden');
      rankEmpty.classList.remove('is-hidden');
      rankHint.classList.add('is-hidden');
    }

    // 점수 프리셋 버튼
    document.addEventListener('click', (e) => {
      const el = e.target.closest('[data-delta]');
      if (!el) return;
      scoreDeltaInput.value = el.getAttribute('data-delta');
    });

    btnAddScore.addEventListener('click', applyScore);
    btnResetScore.addEventListener('click', resetScores);
    btnShowRank.addEventListener('click', showRanking);
    btnRenameTeams.addEventListener('click', () => {
      localStorage.removeItem(LS_KEY_NAMES_SET);
      openTeamModal();
    });

    // =========================
    // 타이머 / 스탑워치 (0.01초 단위)
    // =========================
    function setTimerFromMs(ms) {
      const safeMs = Math.max(0, Math.floor(ms));
      const totalSec = Math.floor(safeMs / 1000);
      const min = Math.floor(totalSec / 60);
      const sec = totalSec % 60;
      const centi = Math.floor((safeMs % 1000) / 10); // 0~99

      tmMinEl.textContent   = String(min).padStart(2, '0');
      tmSecEl.textContent   = String(sec).padStart(2, '0');
      tmCentiEl.textContent = String(centi).padStart(2, '0');
    }

    function updateTimerDisplay() {
      if (timerMode === 'stopwatch') {
        setTimerFromMs(elapsedMs);
      } else {
        setTimerFromMs(remainingMs);
      }
    }

    function clearTimerInterval() {
      if (timerInterval !== null) {
        clearInterval(timerInterval);
        timerInterval = null;
      }
    }

    function setTimerMode(mode) {
      if (timerMode === mode) return;
      timerMode = mode;
      clearTimerInterval();
      elapsedMs = 0;
      remainingMs = 0;
      stopwatchStart = null;
      countdownStart = null;
      updateTimerDisplay();

      if (mode === 'stopwatch') {
        modeStopwatchBtn.classList.add('chip--active');
        modeCountdownBtn.classList.remove('chip--active');
        timerInputRow.classList.add('is-hidden');
      } else {
        modeCountdownBtn.classList.add('chip--active');
        modeStopwatchBtn.classList.remove('chip--active');
        timerInputRow.classList.remove('is-hidden');
      }
    }

    modeStopwatchBtn.addEventListener('click', () => setTimerMode('stopwatch'));
    modeCountdownBtn.addEventListener('click', () => setTimerMode('countdown'));

    function startTimer() {
      if (timerInterval !== null) return;

      if (timerMode === 'stopwatch') {
        const now = performance.now();
        stopwatchStart = now - elapsedMs;

        timerInterval = setInterval(() => {
          const t = performance.now();
          elapsedMs = t - stopwatchStart;
          updateTimerDisplay();  // 0.01초 단위
        }, 10);
      } else {
        if (remainingMs <= 0) {
          const min = Math.max(0, Number(timerMinInput.value) || 0);
          let sec = Math.max(0, Number(timerSecInput.value) || 0);
          if (sec > 59) sec = 59;
          initialCountdownMs = (min * 60 + sec) * 1000;
          remainingMs = initialCountdownMs;
        }
        if (remainingMs <= 0) {
          updateTimerDisplay();
          return;
        }

        const now = performance.now();
        countdownStart = now;
        const startRemaining = remainingMs;

        timerInterval = setInterval(() => {
          const t = performance.now();
          const diff = t - countdownStart;
          remainingMs = Math.max(0, startRemaining - diff);
          updateTimerDisplay();
          if (remainingMs <= 0) {
            clearTimerInterval();
          }
        }, 10);
      }
    }

    function pauseTimer() {
      clearTimerInterval();
    }

    function resetTimer() {
      clearTimerInterval();
      elapsedMs = 0;
      remainingMs = 0;
      stopwatchStart = null;
      countdownStart = null;
      updateTimerDisplay();
    }

    btnTimerStart.addEventListener('click', startTimer);
    btnTimerPause.addEventListener('click', pauseTimer);
    btnTimerReset.addEventListener('click', resetTimer);

    timerInputRow.classList.add('is-hidden');
    updateTimerDisplay();

    // =========================
    // 화면 전환 (메인 ↔ 사다리)
    // =========================
    btnGotoLadder.addEventListener('click', () => {
      mainView.classList.add('is-hidden');
      ladderView.classList.remove('is-hidden');
      stopLadderAnim();
      buildLadder();
      currentStarter = 0;
      updateLadderHint();
    });

    btnBackMain.addEventListener('click', () => {
      ladderView.classList.add('is-hidden');
      mainView.classList.remove('is-hidden');
      stopLadderAnim();
    });

    // =========================
    // 사다리 생성 / 계산
    // =========================
    function generateRungs({ cols, height, minGap = 28, density = 0.16 }) {
      const all = [];
      const maxRungs = Math.floor((height * density) / 2) + 12;

      for (let c = 0; c < cols - 1; c++) {
        const local = [];
        let tries = 0;
        while (local.length < Math.floor(maxRungs / (cols - 1)) && tries < 2000) {
          tries++;
          const y = 50 + Math.random() * (height - 100);
          if (local.every(yy => Math.abs(yy - y) >= minGap)) {
            local.push(y);
          }
        }
        local.sort((a, b) => a - b);
        local.forEach(y => all.push({ y, leftCol: c }));
      }

      all.sort((a, b) => a.y - b.y || a.leftCol - b.leftCol);

      const filtered = [];
      for (let i = 0; i < all.length; i++) {
        const cur = all[i];
        const prev = filtered[filtered.length - 1];
        if (!prev || Math.abs(prev.y - cur.y) > 8 || Math.abs(prev.leftCol - cur.leftCol) > 1) {
          filtered.push(cur);
        }
      }
      return filtered;
    }

    function computeMapping(cols, r) {
      return Array.from({ length: cols }, (_, start) => {
        let col = start;
        for (const rung of r) {
          if (rung.leftCol === col) col++;
          else if (rung.leftCol + 1 === col) col--;
        }
        return col;
      });
    }

    function buildPathForStart(startCol) {
      let col = startCol;
      const pts = [{ x: X_POSITIONS[col], y: TOP_Y }];
      for (const rung of rungs) {
        const y = rung.y;
        pts.push({ x: X_POSITIONS[col], y });
        if (rung.leftCol === col) {
          pts.push({ x: X_POSITIONS[col + 1], y });
          col++;
        } else if (rung.leftCol + 1 === col) {
          pts.push({ x: X_POSITIONS[col - 1], y });
          col--;
        }
      }
      pts.push({ x: X_POSITIONS[col], y: BOTTOM_Y });
      return pts;
    }

    function polylineProgressPoints(points, p) {
      if (!points || points.length < 2) return points || [];
      const segLens = [];
      let total = 0;
      for (let i = 0; i < points.length - 1; i++) {
        const dx = points[i + 1].x - points[i].x;
        const dy = points[i + 1].y - points[i].y;
        const L = Math.hypot(dx, dy);
        segLens.push(L);
        total += L;
      }
      const target = total * p;
      let acc = 0;
      const out = [points[0]];
      for (let i = 0; i < segLens.length; i++) {
        const L = segLens[i];
        const a = points[i];
        const b = points[i + 1];
        if (acc + L <= target) {
          out.push(b);
          acc += L;
        } else {
          const r = Math.max(0, Math.min(1, (target - acc) / L));
          out.push({
            x: a.x + (b.x - a.x) * r,
            y: a.y + (b.y - a.y) * r
          });
          break;
        }
      }
      return out;
    }

    // =========================
    // 사다리 렌더링 / 애니메이션
    // =========================
    function drawLadder() {
      ladderSvg.innerHTML = '';

      // 상단 / 하단 라벨
      X_POSITIONS.forEach((x, i) => {
        const topText = document.createElementNS('http://www.w3.org/2000/svg', 'text');
        topText.setAttribute('x', x);
        topText.setAttribute('y', 20);
        topText.setAttribute('text-anchor', 'middle');
        topText.setAttribute('class', 'svg-top-label');
        topText.textContent = teams[i].name;
        ladderSvg.appendChild(topText);

        const bottomText = document.createElementNS('http://www.w3.org/2000/svg', 'text');
        bottomText.setAttribute('x', x);
        bottomText.setAttribute('y', LADDER_HEIGHT - 8);
        bottomText.setAttribute('text-anchor', 'middle');
        bottomText.setAttribute('class', 'svg-bottom-label');
        bottomText.textContent = '출발 ' + (i + 1);
        ladderSvg.appendChild(bottomText);
      });

      // 세로줄
      X_POSITIONS.forEach((x) => {
        const v = document.createElementNS('http://www.w3.org/2000/svg', 'line');
        v.setAttribute('x1', x);
        v.setAttribute('x2', x);
        v.setAttribute('y1', TOP_Y);
        v.setAttribute('y2', BOTTOM_Y);
        v.setAttribute('class', 'svg-vertical');
        ladderSvg.appendChild(v);
      });

      // 가로줄
      rungs.forEach(r => {
        const h = document.createElementNS('http://www.w3.org/2000/svg', 'line');
        h.setAttribute('x1', X_POSITIONS[r.leftCol]);
        h.setAttribute('x2', X_POSITIONS[r.leftCol + 1]);
        h.setAttribute('y1', r.y);
        h.setAttribute('y2', r.y);
        h.setAttribute('class', 'svg-rung');
        ladderSvg.appendChild(h);
      });
    }

    function drawProgressPolyline(points) {
      const poly = document.createElementNS('http://www.w3.org/2000/svg', 'polyline');
      poly.setAttribute('fill', 'none');
      poly.setAttribute('points', points.map(p => `${p.x},${p.y}`).join(' '));
      poly.setAttribute('class', 'svg-path');
      ladderSvg.appendChild(poly);
      return poly;
    }

    function updateLadderPanels() {
      const mapping = computeMapping(LADDER_COLS, rungs);

      // 출발 → 도착 매핑
      mappingGrid.innerHTML = '';
      mapping.forEach((endCol, startCol) => {
        const div = document.createElement('div');
        div.className = 'map-cell';
        div.innerHTML = `
          <div class="map-team">${teams[startCol].name}</div>
          <div class="map-arrow">${startCol + 1} → ${endCol + 1}</div>
        `;
        mappingGrid.appendChild(div);
      });

      // 도착 순서 (왼→오)
      const pairs = Array.from({ length: LADDER_COLS }, (_, start) => ({
        start,
        end: mapping[start],
      }));
      pairs.sort((a, b) => a.end - b.end);
      ladderOrder.innerHTML = '';
      pairs.forEach((p, idx) => {
        const li = document.createElement('li');
        li.innerHTML = `<span class="order-rank">${idx + 1}</span> ${teams[p.start].name}`;
        ladderOrder.appendChild(li);
      });
    }

    function updateLadderHint() {
      if (currentStarter >= LADDER_COLS) {
        ladderHint.textContent = '모든 팀 이동 완료!';
      } else {
        ladderHint.textContent = '현재 대기: ' + teams[currentStarter].name;
      }
    }

    function stopLadderAnim() {
      cancelAnimationFrame(rafId);
      currentAnimIndex = -1;
      progress = 0;
      drawLadder();
    }

    function tick(ts) {
      const DURATION = 1200;
      if (currentAnimIndex < 0) return;
      if (!tick.startTime) tick.startTime = ts || performance.now();
      const dt = (ts || performance.now()) - tick.startTime;
      progress = Math.min(1, dt / DURATION);

      drawLadder();
      const pts = polylineProgressPoints(paths[currentAnimIndex], progress);
      drawProgressPolyline(pts);

      if (progress >= 1) {
        tick.startTime = null;
        currentAnimIndex = -1;
        currentStarter += 1;
        updateLadderPanels();
        updateLadderHint();
        return;
      }
      rafId = requestAnimationFrame(tick);
    }

    function startOneLadderRun() {
      if (currentStarter >= LADDER_COLS) return;
      if (currentAnimIndex !== -1) return;
      currentAnimIndex = currentStarter;
      progress = 0;
      tick.startTime = null;
      tick();
    }

    btnLadderStep.addEventListener('click', startOneLadderRun);
    ladderSvg.addEventListener('click', startOneLadderRun);
    document.addEventListener('keydown', (e) => {
      if (ladderView.classList.contains('is-hidden')) return;
      if (e.code === 'Space') {
        e.preventDefault();
        startOneLadderRun();
      }
    });

    btnRegenLadder.addEventListener('click', () => {
      stopLadderAnim();
      buildLadder();
      currentStarter = 0;
      updateLadderHint();
    });

    function buildLadder() {
      rungs = generateRungs({ cols: LADDER_COLS, height: LADDER_HEIGHT });
      paths = Array.from({ length: LADDER_COLS }, (_, i) => buildPathForStart(i));
      drawLadder();
      updateLadderPanels();
    }

    // ===== 최초 렌더 =====
    renderTeamChips();
    renderScoreTable();
    buildLadder();
    updateLadderHint();
  </script>
</body>
</html>
